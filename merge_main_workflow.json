{
  "stages": [
    {
      "name": "merge_main",
      "mode": "dynamic",
      "discovery_command": "git fetch --all --prune && git branch -r | grep -v 'HEAD\\|main\\|master' | sed 's|origin/||' | sort -u",
      "item_variable": "branch_name",
      "max_concurrent": 3,
      "continue_on_failure": true,
      "prompt": "You are merging main into branch: {{branch_name}}\n\nWorking directory: {{_working_dir}}\n\n## Instructions\n\n1. First, check current branch and status:\n   git status\n   git branch\n\n2. Fetch latest changes:\n   git fetch origin\n\n3. Checkout the target branch:\n   git checkout {{branch_name}} || git checkout -b {{branch_name}} origin/{{branch_name}}\n\n4. Attempt merge:\n   git merge origin/main --no-edit\n\n5. If there are CONFLICTS:\n   a. List conflicted files: git diff --name-only --diff-filter=U\n   b. For each conflicted file, analyze the conflict and resolve it intelligently:\n      - If it's a simple change (whitespace, import order), auto-resolve\n      - If it's a real conflict, make a decision based on context\n      - Prefer keeping both changes when possible\n   c. After resolving: git add <resolved-files>\n   d. Complete the merge: git commit --no-edit\n\n6. If merge succeeds (no conflicts or resolved):\n   git push origin {{branch_name}}\n\n7. Create a summary document with:\n   - Branch name\n   - Merge status (success/conflict-resolved/failed)\n   - Files changed\n   - Any conflicts that were resolved and how\n   - Push status\n\nSave your report as an emdx document.",
      "synthesis_prompt": "Create a comprehensive merge status report:\n\n## Summary\n- Total branches processed: {{total_items}}\n- Successfully merged: X\n- Conflicts resolved: X\n- Failed: X\n\n## Branch-by-Branch Status\nFor each branch, include:\n- Branch name\n- Status (success/resolved/failed)\n- Key changes or conflicts\n\n## Action Required\nList any branches that need manual attention.\n\nSave as an emdx document titled 'Merge Main Status Report'."
    }
  ],
  "variables": {
    "base_branch": "main"
  }
}
