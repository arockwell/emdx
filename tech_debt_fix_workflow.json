{
  "stages": [
    {
      "name": "tech_debt_parallel_fix",
      "mode": "parallel",
      "runs": 5,
      "prompts": [
        "## Track A: Fix Silent Exception Handlers\n\nYour task is to add logging to ALL silent exception handlers in the emdx codebase.\n\n### Files to Fix:\n\n**Services (emdx/services/):**\n- document_executor.py:160,165 - nested bare exceptions in worktree creation\n- claude_executor.py:51-52 - catches Exception but returns generic error\n- export_destinations.py - find and fix silent handlers\n- similarity.py - find and fix silent handlers\n\n**Commands (emdx/commands/):**\n- gist.py:50,101,108,161,168 - silent subprocess failures\n- maintain.py:627-628 - silent except Exception: pass\n- export_profiles.py - find and fix\n- claude_execute.py - 2 locations\n- gdoc.py - find and fix\n\n**Applications:**\n- emdx/applications/maintenance.py:432 - except Exception: continue\n\n**UI Layer (emdx/ui/):**\n- document_browser.py (9 handlers)\n- text_areas.py (3)\n- git_browser_standalone.py (3)\n- agent_form.py (2)\n- task_browser.py (2)\n- file_browser/navigation.py (2)\n- browser_container.py (1)\n- textual_browser.py (1)\n\n**Utils:**\n- emdx/utils/git.py\n- emdx/utils/logging.py\n- emdx/__init__.py\n\n### Requirements:\n1. Add `import logging` and `logger = logging.getLogger(__name__)` if missing\n2. Before each `pass` or `continue`, add logging:\n   - `logger.debug()` for expected/routine failures\n   - `logger.warning()` for unexpected failures\n3. Catch specific exception types where possible (FileNotFoundError, OSError, etc.)\n4. Keep existing behavior (pass/continue/return still happens)\n\n### Verification:\n```bash\npoetry run pytest tests/ -x -q\n```\n\nSave a summary of changes as an emdx document with tags: tech-debt, exception-handling, track-a",

        "## Track B: Code Deduplication - Shared Console & CLI Utils\n\nYour task is to eliminate code duplication by creating shared modules.\n\n### Task B1: Create Shared Console Module\nCreate `emdx/utils/output.py`:\n```python\n\"\"\"Shared console output utilities.\"\"\"\nfrom rich.console import Console\n\n# Shared console instance for all CLI output\nconsole = Console()\n```\n\n### Task B2-B5: Migrate All Console Instantiations\nUpdate ALL files that have `console = Console()` to import from shared module.\n\n**Files to update (20 total):**\n- emdx/main.py\n- emdx/commands/analyze.py\n- emdx/commands/agents.py\n- emdx/commands/browse.py\n- emdx/commands/core.py\n- emdx/commands/executions.py\n- emdx/commands/gc.py\n- emdx/commands/gdoc.py\n- emdx/commands/gist.py\n- emdx/commands/lifecycle.py\n- emdx/commands/maintain.py\n- emdx/commands/tags.py\n- emdx/commands/tasks.py\n- emdx/commands/workflows.py\n- emdx/commands/claude_execute.py\n- emdx/commands/export.py\n- emdx/commands/export_profiles.py\n- emdx/commands/similarity.py\n- emdx/ui/gui.py\n- emdx/utils/environment.py\n\nFor each file:\n1. Remove `from rich.console import Console`\n2. Remove `console = Console()`\n3. Add `from emdx.utils.output import console`\n\n### Task B6: Create CLI Error Decorator\nCreate `emdx/utils/cli.py`:\n```python\n\"\"\"CLI utilities for error handling.\"\"\"\nimport functools\nfrom typing import Callable, TypeVar\nimport typer\nfrom emdx.utils.output import console\n\nF = TypeVar('F', bound=Callable)\n\ndef handle_cli_errors(action: str) -> Callable[[F], F]:\n    \"\"\"Decorator that catches exceptions and prints user-friendly errors.\"\"\"\n    def decorator(func: F) -> F:\n        @functools.wraps(func)\n        def wrapper(*args, **kwargs):\n            try:\n                return func(*args, **kwargs)\n            except typer.Exit:\n                raise\n            except Exception as e:\n                console.print(f\"[red]Error {action}: {e}[/red]\")\n                raise typer.Exit(1) from e\n        return wrapper\n    return decorator\n```\n\n### Task B7: Standardize Logger Initialization\n1. Check emdx/utils/logging.py for get_logger() utility\n2. Standardize all files to use same pattern\n\n### Verification:\n```bash\npoetry run pytest tests/ -x -q\nrg \"console = Console\\(\\)\" emdx/  # Should return nothing\n```\n\nSave summary as emdx document with tags: tech-debt, deduplication, track-b",

        "## Track C: Type Safety - Replace Any Types\n\nYour task is to add proper type annotations to replace `Any` types.\n\n### Task C1: Workflow Services Types\nFile: `emdx/workflows/services.py`\n\n1. Add at top of file:\n```python\nfrom typing import TypedDict, Optional, List\n\nclass ExecutionResult(TypedDict):\n    id: int\n    doc_id: Optional[int]\n    doc_title: str\n    status: str\n    started_at: str\n    completed_at: Optional[str]\n    log_file: str\n    exit_code: Optional[int]\n    working_dir: Optional[str]\n    pid: Optional[int]\n```\n\n2. Update `get_execution()` return type from `Optional[Any]` to `Optional[ExecutionResult]`\n\n### Task C2: Execution Data Manager Types\nFile: `emdx/ui/execution_data_manager.py`\n\n1. Define GitWorktree TypedDict based on actual fields used:\n```python\nclass GitWorktree(TypedDict):\n    path: str\n    branch: str\n    commit: str\n    is_bare: bool\n    is_current: bool\n```\n\n2. Update:\n- `project_worktrees: List[Any]` → `project_worktrees: List[GitWorktree]`\n- `worktrees: Optional[List[Any]]` → `worktrees: Optional[List[GitWorktree]]`\n\n### Task C3: Auto-Tagger Types\nFile: `emdx/services/auto_tagger.py`\n\nLine 305: `params: List[Any] = []`\n\nChange to:\n```python\nfrom typing import Union\nSqlParam = Union[str, int, float, None]\nparams: List[SqlParam] = []\n```\n\n### Verification:\n```bash\npoetry run pytest tests/ -x -q\n# Optional: poetry run mypy emdx/workflows/services.py emdx/ui/execution_data_manager.py\n```\n\nSave summary as emdx document with tags: tech-debt, type-safety, track-c",

        "## Track D: Dead Code Cleanup\n\nYour task is to remove dead code, deprecated stubs, and redundant statements.\n\n### Task D1: Remove Deprecated Browser Stubs\nFile: `emdx/ui/textual_browser.py`\n\n1. First verify no code imports these:\n```bash\nrg \"MinimalDocumentBrowser|run_minimal\" --type py\n```\n\n2. Remove lines 20-28 (the deprecated stub functions)\n3. Remove duplicate import at line 31 (`from textual.widgets import Static` appears twice)\n\n### Task D2: Clean Up Redundant Pass Statements\nFind all with:\n```bash\nrg \"except.*:\" -A2 emdx/ | grep -B1 \"^\\s*pass\\s*$\"\n```\n\nRemove `pass` statements that follow other statements. Keep `pass` only when it's the sole statement in the block.\n\nExample - REMOVE the pass here:\n```python\nexcept Exception as e:\n    logger.error(f\"Error: {e}\")\n    pass  # <- REMOVE THIS\n```\n\nExample - KEEP the pass here:\n```python\nexcept FileNotFoundError:\n    pass  # <- KEEP THIS (it's the only statement)\n```\n\n### Task D3: Remove Unused db_path Parameter\nFile: `emdx/services/duplicate_detector.py`\n\n1. Check for callers:\n```bash\nrg \"DuplicateDetector\\(\" --type py\n```\n\n2. If no callers pass db_path, remove the parameter from __init__\n3. Remove the comment about backwards compatibility\n\n### Task D4: Document Legacy Code\nFile: `emdx/commands/claude_execute.py`\n\nFind comments like `# Legacy behavior` and `# Legacy execution mode`.\nEither:\n- Add proper docstring explaining WHY it's needed, OR\n- Remove the legacy code if it's no longer needed\n\n### Verification:\n```bash\npoetry run pytest tests/ -x -q\n```\n\nSave summary as emdx document with tags: tech-debt, cleanup, track-d",

        "## Track E: Architecture & Implementation Fixes\n\nYour task is to fix architectural issues and implement missing functionality.\n\n### Task E1: Implement Log Stream Polling Fallback (CRITICAL)\nFile: `emdx/services/log_stream.py`\n\nThe `_start_polling_fallback()` method at lines 124-130 is a stub.\n\nImplement it:\n```python\nimport threading\nimport time\n\ndef _start_polling_fallback(self) -> None:\n    \"\"\"Fallback to polling if file watching fails.\"\"\"\n    logger.warning(\"File watching failed, using polling fallback\")\n    \n    self._poll_interval = getattr(self, '_poll_interval', 1.0)\n    self._polling = True\n    \n    def poll_loop():\n        while getattr(self, '_polling', False) and not getattr(self, '_stopped', False):\n            try:\n                content = self._read_new_content()\n                if content:\n                    self._notify_subscribers(content)\n            except Exception as e:\n                logger.debug(f\"Polling error: {e}\")\n            time.sleep(self._poll_interval)\n    \n    self._poll_thread = threading.Thread(target=poll_loop, daemon=True, name=\"log-poll\")\n    self._poll_thread.start()\n```\n\nAlso add cleanup in close/stop method:\n```python\nself._polling = False\n```\n\n### Task E2: Implement Log View Search\nFile: `emdx/ui/pulse/zoom2/log_view.py`\n\nLine 285 has placeholder `action_search()`. Implement basic search:\n1. Add a search input widget\n2. Filter/highlight matching lines\n3. Escape to clear search\n\n### Task E3: Move Imports Out of Exception Handlers\nFile: `emdx/services/document_executor.py`\n\nLines 160-164 have `import tempfile` inside exception handler.\nMove to top of file with other imports.\n\n### Task E4: Handle Pattern Usage Tracking Stub\nFile: `emdx/services/auto_tagger.py`\n\nLines 474-476 raise NotImplementedError.\n\nOption A: Remove the method if not needed\nOption B: Implement basic tracking\n\nCheck if anything calls this method first:\n```bash\nrg \"pattern.*usage|usage.*pattern\" --type py\n```\n\n### Verification:\n```bash\npoetry run pytest tests/ -x -q\n```\n\nSave summary as emdx document with tags: tech-debt, architecture, track-e"
      ],
      "synthesis_prompt": "## Tech Debt Fix Synthesis\n\nCombine all track results into a comprehensive report.\n\n### Required Sections:\n\n1. **Executive Summary**\n   - Total files modified\n   - Total issues fixed\n   - Test status\n\n2. **Track A Results: Exception Handling**\n   - List of files modified\n   - Number of silent handlers fixed\n   - Any issues encountered\n\n3. **Track B Results: Code Deduplication**\n   - Confirm shared console module created\n   - List files migrated\n   - CLI decorator status\n\n4. **Track C Results: Type Safety**\n   - TypedDicts created\n   - Any types replaced\n\n5. **Track D Results: Dead Code**\n   - Code removed\n   - Bytes/lines saved\n\n6. **Track E Results: Architecture**\n   - Polling fallback implementation status\n   - Search implementation status\n   - Other fixes\n\n7. **Remaining Work**\n   - Any items that couldn't be completed\n   - Recommended follow-up tasks\n\n8. **Test Results**\n   - Final test run output\n   - Any new failures introduced\n\nSave as emdx document with title 'Tech Debt Fix Report - [DATE]' and tags: tech-debt, fix-report, comprehensive, synthesis"
    }
  ],
  "variables": {}
}
